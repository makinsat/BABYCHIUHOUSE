<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VIP LOUNGE</title>
  
  <!-- 1. å­—é«”æ”¹ç‚º Montserrat (æ”¯æ´ç²—ç´°è®ŠåŒ–) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase Compat (çµ±ä¸€ä½¿ç”¨ 10.8.1) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <style>
    /* å…¨ç«™å­—é«”èˆ‡é»‘é‡‘é…è‰²è®Šæ•¸ */
    :root {
      --bg-dark: #121212;
      --card-dark: #1e1e1e;
      --text-main: #e5e5e5;
      --text-muted: #a3a3a3;
      --gold-main: #d4af37;
      --gold-light: #f1c40f;
    }

    /* æ‡‰ç”¨ Montserrat å­—é«” */
    * { font-family: 'Montserrat', sans-serif !important; }
    
    body { 
      background-color: var(--bg-dark); 
      color: var(--text-main); 
      -webkit-tap-highlight-color: transparent; 
      font-weight: 400; 
      overflow-x: hidden; 
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #root { opacity: 0; transition: opacity 0.5s ease-in; }
    #root.loaded { opacity: 1; }
    
    @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .animate-float { animation: floating 4s ease-in-out infinite; }
    
    /* ä¿æŒæ–¹æ­£é¢¨æ ¼ */
    img { display: block; max-width: 100%; height: auto; border-radius: 0px; }
    
    /* é»‘é‡‘æ¼¸å±¤èƒŒæ™¯ */
    .vip-gradient { background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); border-bottom: 1px solid #333; }
    .gold-text-gradient { background: linear-gradient(to right, #d4af37, #f1c40f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 0; }
    
    /* å…Œæ›åˆ¸æ¨£å¼ - æ–¹å½¢ */
    .coupon-card {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 0;
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
    }
    .coupon-card::before, .coupon-card::after {
      content: '';
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--bg-dark);
      border-radius: 0;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      border: 1px solid #333;
    }
    .coupon-card::before { left: -6px; border-right: none; }
    .coupon-card::after { right: -6px; border-left: none; }

    .coupon-used { filter: grayscale(1); opacity: 0.5; border-color: #444; }

    /* é‡‘è‰²æŒ‰éˆ•æ¨£å¼ - æ–¹å½¢ */
    .btn-action {
      background: linear-gradient(135deg, #d4af37, #c5a028);
      color: #000;
      transition: all 0.3s ease;
      font-weight: 700;
      border-radius: 0;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.1);
    }
    .btn-action:active { transform: scale(0.98); box-shadow: none; }
    .btn-action:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    .log-item { border-bottom: 1px solid #333; }
    .log-item:last-child { border-bottom: none; }
    
    /* è·‘é¦¬ç‡ˆ */
    .marquee { white-space: nowrap; overflow: hidden; box-sizing: border-box; }
    .marquee span { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
    @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
    
    input, textarea { font-weight: 300 !important; color: white !important; border-radius: 0 !important; }
    button { font-weight: 600 !important; border-radius: 0 !important; }
    
    /* Range Slider (æ©Ÿç‡èª¿æ•´ç”¨) */
    input[type=range] { -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 16px; width: 16px; background: #d4af37; cursor: pointer; margin-top: -6px; border-radius: 0;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; cursor: pointer; background: #333;
    }

    /* æ’²å…‹ç‰Œæ¨£å¼ */
    .card {
      width: 50px;
      height: 70px;
      background: white;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 4px;
      font-weight: bold;
      font-size: 12px;
      color: black;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      position: relative;
    }
    .card.red { color: #e74c3c; }
    .card.hidden { 
      background: repeating-linear-gradient(45deg, #b71c1c, #b71c1c 5px, #c62828 5px, #c62828 10px);
      border: 2px solid white;
    }
    .card .suit { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; opacity: 0.2; }
    .card .val-top { align-self: flex-start; line-height: 1; }
    .card .val-bottom { align-self: flex-end; transform: rotate(180deg); line-height: 1; }

    /* è½‰ç›¤æ¨£å¼ - å„ªåŒ–ç‰ˆ */
    .wheel-container {
      position: relative;
      width: 280px; /* ç¨å¾®åŠ å¤§ */
      height: 280px;
      margin: 0 auto;
    }
    .wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 8px solid #d4af37; /* åŠ ç²—é‚Šæ¡† */
      position: relative;
      /* å»¶é•·å‹•ç•«æ™‚é–“è‡³ 10sï¼Œä½¿ç”¨æ›´è‡ªç„¶çš„è²èŒ²æ›²ç·š */
      transition: transform 10s cubic-bezier(0.25, 0.1, 0.25, 1);
      /* é«˜å°æ¯”è‰²å¡Šï¼šé‡‘ã€é»‘ã€ç™½äº¤æ›¿ */
      background: conic-gradient(
        #d4af37 0% 16.66%,   /* x5 GOLD */
        #1e1e1e 16.66% 33.33%, /* x2 BLACK */
        #e5e5e5 33.33% 50%,   /* x1 WHITE */
        #1e1e1e 50% 66.66%,   /* x0.5 BLACK */
        #e5e5e5 66.66% 83.33%, /* x0.25 WHITE */
        #000000 83.33% 100%   /* x0 DARK BLACK */
      );
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
    }
    /* æ–‡å­—æ¨™ç±¤å®šä½ - ä¿®æ­£ */
    .wheel-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: center; /* é—œéµï¼šå¾ä¸­å¿ƒæ—‹è½‰ */
      font-weight: 800;
      font-size: 18px; /* åŠ å¤§å­—é«” */
      white-space: nowrap;
      pointer-events: none;
      /* æ–‡å­—é™°å½±å¢å¼·å¯è®€æ€§ */
      text-shadow: 0 1px 3px rgba(0,0,0,0.8); 
    }
    /* é‡å°ä¸åŒèƒŒæ™¯è‰²çš„æ–‡å­—é¡è‰²èª¿æ•´ */
    .label-on-dark { color: #d4af37; }
    .label-on-light { color: #000; text-shadow: none; }
    .label-on-gold { color: #000; text-shadow: none; }

    /* æŒ‡é‡ */
    .wheel-arrow {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; 
      height: 0; 
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 30px solid #ef4444; /* æ›´æ˜é¡¯çš„ç´…è‰² */
      z-index: 20;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
    }
    .wheel-center {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 50px; height: 50px;
      background: #d4af37;
      border: 4px solid #111;
      border-radius: 50%;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>

  <div id="root"></div>

  <!-- Loading -->
  <div id="loading-screen" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; color:#d4af37; font-weight:300; z-index:100;">
    <div class="animate-float" style="font-size: 40px; margin-bottom: 10px;">ğŸ‘‘</div>
    <div style="letter-spacing: 2px; font-size: 13px; color: #888;">LOADING VIP SYSTEM...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, increment, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyJpNrkcVCefwq53wQDQZmZGhjOJpv27c",
      authDomain: "makinsat-36a6e.firebaseapp.com",
      projectId: "makinsat-36a6e",
      storageBucket: "makinsat-36a6e.firebasestorage.app",
      messagingSenderId: "213997948286",
      appId: "1:213997948286:web:116d44046db0f41a8e772f",
      measurementId: "G-8V2K5MLTDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "babychiu");
    const finalAppId = "vip-lounge-v2"; 

    window.fb = { 
      db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, 
      increment, serverTimestamp, deleteDoc, appId: finalAppId, 
      signInAnonymously, onAuthStateChanged 
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, Fragment } = React;
    const { 
      db, auth, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, 
      increment, serverTimestamp, deleteDoc, appId,
      signInAnonymously, onAuthStateChanged 
    } = window.fb;

    // --- SVG Icons (ä¿æŒæ–¹æ­£é¢¨æ ¼) ---
    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        Point: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />, 
        Home: (<Fragment><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Fragment>),
        Camera: (<Fragment><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Fragment>),
        Gift: (<Fragment><rect x="3" y="8" width="18" height="4" rx="0"/><path d="M12 8v13M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></Fragment>),
        Bell: (<Fragment><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></Fragment>),
        Lock: (<Fragment><rect x="3" y="11" width="18" height="11" rx="0"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Fragment>),
        LogOut: (<Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Fragment>),
        Trash2: (<Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Fragment>),
        Ticket: (<Fragment><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4a2 2 0 0 0 0 4v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4a2 2 0 0 0 0-4Z"/><path d="M13 3v18M9 3v18M15 3v18"/></Fragment>),
        Store: (<Fragment><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></Fragment>),
        Chart: (<Fragment><path d="M12 20V10M18 20V4M6 20v-4"/></Fragment>),
        Check: <polyline points="20 6 9 17 4 12"/>,
        Alert: (<Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Fragment>),
        History: (<Fragment><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></Fragment>),
        Sparkles: (<Fragment><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4M9 3v4M3 5h4M3 9h4"/></Fragment>),
        Image: (<Fragment><rect x="3" y="3" width="18" height="18" rx="0"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Fragment>),
        Plus: (<Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Fragment>),
        User: (<Fragment><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Fragment>),
        Dice: (<Fragment><rect x="3" y="3" width="18" height="18" rx="0"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></Fragment>),
        Droplet: (<Fragment><path d="M12 2.69l5.74 5.88a8.1 8.1 0 1 1-11.48 0L12 2.69z"/><path d="M12 22a7 7 0 0 1-7-7c0-2.32 1.15-4.36 2.87-5.59"/><path d="M12 8v8"/></Fragment>),
        Book: (<Fragment><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></Fragment>),
        Minus: <line x1="5" y1="12" x2="19" y2="12"/>,
        Cards: (<Fragment><rect x="6" y="2" width="12" height="16" rx="2" ry="2" /><line x1="9" y1="2" x2="9" y2="18" /><path d="M15 18l-3 3l-3 -3" /></Fragment>),
        Wheel: (<Fragment><circle cx="12" cy="12" r="10"/><path d="M12 12 12 2"/><path d="M12 12 20.66 7"/><path d="M12 12 20.66 17"/><path d="M12 12 12 22"/><path d="M12 12 3.34 17"/><path d="M12 12 3.34 7"/></Fragment>),
        Star: (<Fragment><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></Fragment>)
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
          {icons[name] || null}
        </svg>
      );
    };

    // Blackjack Logic Helpers
    const createDeck = () => {
      const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
      const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
      let deck = [];
      for (let s of suits) {
        for (let v of values) {
          deck.push({ suit: s, value: v, color: (s === 'â™¥' || s === 'â™¦') ? 'red' : 'black' });
        }
      }
      // Shuffle
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    };

    const calculateHand = (hand) => {
      let sum = 0;
      let aces = 0;
      for (let card of hand) {
        if (['J', 'Q', 'K'].includes(card.value)) sum += 10;
        else if (card.value === 'A') { sum += 11; aces += 1; }
        else sum += parseInt(card.value);
      }
      while (sum > 21 && aces > 0) {
        sum -= 10;
        aces -= 1;
      }
      return sum;
    };

    const compressImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 400; 
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.5)); 
          };
        };
      });
    };

    function App() {
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('dashboard'); // é è¨­é¦–é 
      const [activeGame, setActiveGame] = useState(null); // 'blackjack' or 'wheel'
      const [isAdmin, setIsAdmin] = useState(false);
      const [points, setPoints] = useState(0);
      const [stats, setStats] = useState({ totalIssued: 0, totalRedeemed: 0 });
      const [settings, setSettings] = useState({ announce: 'Welcome to VIP Lounge', lotteryProb: 0.1 }); // æ–°å¢è¨­å®šç‹€æ…‹
      const [submissions, setSubmissions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [announcement, setAnnouncement] = useState('Welcome to VIP Lounge ğŸ–¤');
      const [loading, setLoading] = useState(true);
      const [showNotifModal, setShowNotifModal] = useState(false); // é€šçŸ¥å½ˆçª—

      // è‹±æ–‡æ‰“å¡ç‹€æ…‹
      const [desc, setDesc] = useState('');
      const [selectedFile, setSelectedFile] = useState(null);
      
      // å¥½äº‹æ‰“å¡ç‹€æ…‹
      const [deedDesc, setDeedDesc] = useState('');
      const [deedFile, setDeedFile] = useState(null);

      const [isUploading, setIsUploading] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [adminPass, setAdminPass] = useState('');
      const [showAdminLogin, setShowAdminLogin] = useState(false);

      const [waterCount, setWaterCount] = useState(250); // æ°´é‡é è¨­

      const [adminRewardName, setAdminRewardName] = useState('');
      const [adminRewardCost, setAdminRewardCost] = useState('');
      const [adminRewardImage, setAdminRewardImage] = useState(null);
      const [isAddingReward, setIsAddingReward] = useState(false);
      const [approvalPoints, setApprovalPoints] = useState({});
      const [penaltyDesc, setPenaltyDesc] = useState('');
      const [penaltyAmount, setPenaltyAmount] = useState('');

      // Blackjack State
      const [bjDeck, setBjDeck] = useState([]);
      const [bjPlayerHand, setBjPlayerHand] = useState([]);
      const [bjDealerHand, setBjDealerHand] = useState([]);
      const [bjGameState, setBjGameState] = useState('betting'); // betting, playing, gameOver
      const [bjMessage, setBjMessage] = useState('');
      const [bjBet, setBjBet] = useState(0.25);

      // Wheel State
      const [wheelRotation, setWheelRotation] = useState(0);
      const [isSpinning, setIsSpinning] = useState(false);
      const [wheelResult, setWheelResult] = useState('');

      const getPublicRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

      useEffect(() => {
        signInAnonymously(auth)
          .then(() => {})
          .catch((error) => {
            console.error("Auth Error (Fallback to Guest):", error);
            const guestUser = { uid: "guest_" + Math.random().toString(36).substring(7) };
            setUser(guestUser);
            setLoading(false);
            const ls = document.getElementById('loading-screen');
            if (ls) ls.style.display = 'none';
            const rt = document.getElementById('root');
            if (rt) rt.classList.add('loaded');
          });

        return onAuthStateChanged(auth, (u) => {
          if (u) {
            setUser(u);
            setLoading(false);
            const ls = document.getElementById('loading-screen');
            if (ls) ls.style.display = 'none';
            const rt = document.getElementById('root');
            if (rt) rt.classList.add('loaded');
          }
        });
      }, []);

      useEffect(() => {
        if (!user) return;
        
        // è®€å–é»æ•¸
        const unsubStats = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), (d) => {
          if (d.exists()) {
            setPoints(d.data().totalPoints || 0);
            setStats({ totalIssued: d.data().totalIssued || 0, totalRedeemed: d.data().totalRedeemed || 0 });
          } else {
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { totalPoints: 0, totalIssued: 0, totalRedeemed: 0 });
          }
        });
        
        // è®€å–è¨­å®š (è·‘é¦¬ç‡ˆ & æ©Ÿç‡)
        const unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), (d) => {
          if (d.exists()) {
            setSettings(d.data());
            setAnnouncement(d.data().announce || 'Welcome');
          } else {
            // é è¨­å€¼
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { announce: 'Welcome', lotteryProb: 0.1 });
          }
        });

        const unsubSubs = onSnapshot(getPublicRef('submissions'), (s) => {
          const data = s.docs.map(d => ({id: d.id, ...d.data()}));
          data.sort((a, b) => (b.timestamp?.toMillis ? b.timestamp.toMillis() : Date.now()) - (a.timestamp?.toMillis ? a.timestamp.toMillis() : Date.now()));
          setSubmissions(data);
        });

        const unsubRewards = onSnapshot(getPublicRef('rewards'), (s) => {
          const data = s.docs.map(d => ({id: d.id, ...d.data()}));
          data.sort((a, b) => (a.available === b.available) ? (a.cost - b.cost) : (a.available ? -1 : 1));
          setRewards(data);
        });

        const unsubNotifs = onSnapshot(getPublicRef('notifications'), (s) => {
          const data = s.docs.map(d => ({id: d.id, ...d.data()}));
          data.sort((a, b) => (b.timestamp?.toMillis ? b.timestamp.toMillis() : Date.now()) - (a.timestamp?.toMillis ? a.timestamp.toMillis() : Date.now()));
          setNotifications(data);
        });
        return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubNotifs(); unsubSettings(); };
      }, [user]);

      const deleteItem = async (e, colName, id, itemName) => {
        if (e && e.stopPropagation) e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${itemName}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
        
        try { 
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, id)); 
        } catch (err) { 
          console.error("Delete Error:", err);
          alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); 
        }
      };

      const checkAdmin = () => {
        const secret = [53, 50, 48]; 
        const inputCodes = Array.from(adminPass).map(c => c.charCodeAt(0));
        if (JSON.stringify(secret) === JSON.stringify(inputCodes)) {
          setIsAdmin(true); 
          setShowAdminLogin(false); 
          setAdminPass(''); 
          setActiveTab('admin'); // ç™»å…¥å¾Œè‡ªå‹•è·³è½‰åˆ°ç®¡ç†é 
        } else { alert('å¯†ç¢¼éŒ¯èª¤ ğŸ”’'); }
      };

      // --- Wheel Game Functions ---
      const spinWheel = async () => {
        const cost = 0.25;
        if (points < cost) return alert("é»æ•¸ä¸è¶³ 0.25ï¼");
        if (isSpinning) return;

        try {
          setIsSpinning(true);
          setWheelResult('');
          
          // Deduct cost
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
            totalPoints: increment(-cost),
            totalRedeemed: increment(cost)
          });
          
          await addDoc(getPublicRef('submissions'), {
            description: `ğŸ¡ è½‰ç›¤ï¼šå…¥å ´è²»`,
            status: 'spent', 
            timestamp: serverTimestamp(),
            userId: user.uid,
            awardedPoints: -cost
          });

          // Wheel Configuration - é †æ™‚é˜æ’åˆ— (å°æ‡‰ CSS conic-gradient)
          const segments = [
            { label: 'x5', multiplier: 5, weight: 5, index: 0 },
            { label: 'x2', multiplier: 2, weight: 10, index: 1 },
            { label: 'x1', multiplier: 1, weight: 20, index: 2 },
            { label: 'x0.5', multiplier: 0.5, weight: 25, index: 3 },
            { label: 'x0.25', multiplier: 0.25, weight: 15, index: 4 },
            { label: 'x0', multiplier: 0, weight: 25, index: 5 }
          ];
          
          // Weighted Random
          let totalWeight = segments.reduce((acc, s) => acc + s.weight, 0);
          let random = Math.random() * totalWeight;
          let selected = null;
          let accumulatedWeight = 0;

          for (let i = 0; i < segments.length; i++) {
            accumulatedWeight += segments[i].weight;
            if (random <= accumulatedWeight) {
              selected = segments[i];
              break;
            }
          }

          // Calculate rotation
          const segmentAngle = 60;
          const targetAngle = 360 - (selected.index * segmentAngle + 30);
          
          // Add extra spins (Updated to 10 seconds duration)
          const baseRotation = 3600 * 2; // more spins
          const finalRotation = baseRotation + targetAngle;

          setWheelRotation(finalRotation);

          setTimeout(async () => {
            setIsSpinning(false);
            const winAmount = cost * selected.multiplier;
            let msg = '';
            
            if (selected.multiplier > 1) msg = `å¤§çï¼x${selected.multiplier} ğŸ‰`;
            else if (selected.multiplier === 1) msg = `ä¿æœ¬ x1 ğŸ˜…`;
            else if (selected.multiplier > 0) msg = `æ‹¿å›éƒ¨åˆ† x${selected.multiplier} ğŸ’¸`;
            else msg = `æ§“é¾œ x0 ğŸ’¨`;

            setWheelResult(msg);

            if (winAmount > 0) {
               await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
                totalPoints: increment(winAmount),
                totalIssued: increment(Math.max(0, winAmount - cost))
              });
              
              await addDoc(getPublicRef('submissions'), {
                description: `ğŸ¡ è½‰ç›¤ï¼š${msg}`,
                status: 'won', 
                timestamp: serverTimestamp(),
                userId: user.uid,
                awardedPoints: winAmount
              });
            }
          }, 10000); // 10 seconds animation

        } catch (e) { 
          setIsSpinning(false); 
          alert("éŠæˆ²éŒ¯èª¤"); 
        }
      };

      // --- Blackjack Functions ---
      const startBlackjack = async () => {
        const cost = 0.25;
        if (points < cost) return alert("é»æ•¸ä¸è¶³ 0.25ï¼");
        
        try {
          // Deduct entry fee
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
            totalPoints: increment(-cost),
            totalRedeemed: increment(cost)
          });
          
          // Record transaction (Status: 'spent' to avoid showing as coupon)
          await addDoc(getPublicRef('submissions'), {
            description: `â™ ï¸ 21é»ï¼šå…¥å ´è²»`,
            status: 'spent', // shows as negative/spending but NOT coupon
            timestamp: serverTimestamp(),
            userId: user.uid,
            awardedPoints: -cost
          });

          const newDeck = createDeck();
          const pHand = [newDeck.pop(), newDeck.pop()];
          const dHand = [newDeck.pop(), newDeck.pop()];
          
          setBjDeck(newDeck);
          setBjPlayerHand(pHand);
          setBjDealerHand(dHand);
          setBjBet(cost);
          setBjGameState('playing');
          setBjMessage('');

          // Check natural blackjack immediately
          if (calculateHand(pHand) === 21) {
             finishBlackjack(pHand, dHand, cost, true);
          }

        } catch (e) { alert("éŠæˆ²å•Ÿå‹•å¤±æ•—"); }
      };

      const hitBlackjack = () => {
        const newDeck = [...bjDeck];
        const card = newDeck.pop();
        const newHand = [...bjPlayerHand, card];
        setBjDeck(newDeck);
        setBjPlayerHand(newHand);
        
        if (calculateHand(newHand) > 21) {
          setBjGameState('gameOver');
          setBjMessage('çˆ†ç‰Œäº†ï¼(Bust) ğŸ’¸');
          // No refund, already deducted
        } else if (newHand.length === 5) {
          // 5-Card Charlie logic
          finishBlackjack(newHand, bjDealerHand, bjBet, false, true); 
        }
      };

      const standBlackjack = () => {
        let currentDeck = [...bjDeck];
        let currentDHand = [...bjDealerHand];
        
        // Dealer AI: Hit until 17
        while (calculateHand(currentDHand) < 17) {
          currentDHand.push(currentDeck.pop());
        }
        setBjDeck(currentDeck);
        setBjDealerHand(currentDHand);
        finishBlackjack(bjPlayerHand, currentDHand, bjBet, false);
      };

      const doubleBlackjack = async () => {
        if (bjPlayerHand.length !== 2) return;
        const extraCost = 0.25;
        if (points < extraCost) return alert("é»æ•¸ä¸è¶³ï¼Œç„¡æ³•é›™å€ä¸‹æ³¨ï¼");

        try {
           await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
            totalPoints: increment(-extraCost),
            totalRedeemed: increment(extraCost)
          });
          
          // Record transaction (Status: 'spent')
          await addDoc(getPublicRef('submissions'), {
            description: `â™ ï¸ 21é»ï¼šé›™å€ä¸‹æ³¨`,
            status: 'spent',
            timestamp: serverTimestamp(),
            userId: user.uid,
            awardedPoints: -extraCost
          });
          
          // Deal one card then stand
          const newDeck = [...bjDeck];
          const card = newDeck.pop();
          const newHand = [...bjPlayerHand, card];
          
          // Dealer logic immediately
          let currentDHand = [...bjDealerHand];
          // Check player bust first
          if (calculateHand(newHand) > 21) {
             setBjPlayerHand(newHand);
             setBjBet(bjBet + extraCost);
             setBjGameState('gameOver');
             setBjMessage('é›™å€ä¸‹æ³¨...ä½†çˆ†ç‰Œäº†ï¼ ğŸ’¸');
             return;
          }

          while (calculateHand(currentDHand) < 17) {
            currentDHand.push(newDeck.pop());
          }

          setBjDeck(newDeck);
          setBjPlayerHand(newHand);
          setBjDealerHand(currentDHand);
          setBjBet(bjBet + extraCost);
          finishBlackjack(newHand, currentDHand, bjBet + extraCost, false);

        } catch(e) { alert("é›™å€ä¸‹æ³¨å¤±æ•—"); }
      };

      const finishBlackjack = async (pHand, dHand, currentBet, isNatural, isFiveCardCharlie = false) => {
        const pScore = calculateHand(pHand);
        const dScore = calculateHand(dHand);
        let winAmount = 0;
        let msg = '';

        if (pScore > 21) {
          msg = 'çˆ†ç‰Œäº†ï¼ä½ è¼¸äº† ğŸ’¸';
        } else if (isFiveCardCharlie) {
          msg = 'éäº”é—œï¼ä½ è´äº†ï¼ ğŸ‰';
          winAmount = currentBet * 2;
        } else if (dScore > 21) {
          msg = 'èŠå®¶çˆ†ç‰Œï¼ä½ è´äº†ï¼ ğŸ‰';
          winAmount = currentBet * 2;
        } else if (pScore > dScore) {
          msg = 'ä½ è´äº†ï¼ ğŸ‰';
          winAmount = currentBet * 2;
        } else if (pScore === dScore) {
          msg = 'å¹³æ‰‹ (Push) ğŸ¤';
          winAmount = currentBet;
        } else {
          msg = 'èŠå®¶è´äº† ğŸ’¸';
        }

        setBjGameState('gameOver');
        setBjMessage(msg);

        if (winAmount > 0) {
          try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
              totalPoints: increment(winAmount),
              totalIssued: increment(winAmount - currentBet) // only count profit as issued
            });
            
            // Record winnings (Status: 'won')
            await addDoc(getPublicRef('submissions'), {
              description: `â™ ï¸ 21é»ï¼šç²å‹çå‹µ (${msg})`,
              status: 'won', // shows as positive/income
              timestamp: serverTimestamp(),
              userId: user.uid,
              awardedPoints: winAmount
            });
          } catch(e) { console.error(e); }
        }
      };

      const handleUploadTask = async () => {
        if (!desc.trim() || !selectedFile) return alert("è«‹è¼¸å…¥èªªæ˜ä¸¦ä¸Šå‚³ç…§ç‰‡ â˜ï¸");
        setIsUploading(true);
        try {
          const imgBase64 = await compressImage(selectedFile);
          await addDoc(getPublicRef('submissions'), {
            description: `ğŸ“– è‹±æ–‡æ‰“å¡ï¼š${desc}`, image: imgBase64, status: 'pending', timestamp: serverTimestamp(), userId: user.uid
          });
          setDesc(''); setSelectedFile(null); alert("æ‰“å¡æˆåŠŸï¼ç­‰å¾…åº—é•·å¯©æ ¸");
        } catch(e){ alert("å¤±æ•—"); } finally { setIsUploading(false); }
      };

      const handleGoodDeedTask = async () => {
        if (!deedDesc.trim() || !deedFile) return alert("è«‹è¼¸å…¥èªªæ˜ä¸¦ä¸Šå‚³ç…§ç‰‡ ğŸŒŸ");
        setIsUploading(true);
        try {
          const imgBase64 = await compressImage(deedFile);
          await addDoc(getPublicRef('submissions'), {
            description: `ğŸŒŸ å¥½äº‹æ‰“å¡ï¼š${deedDesc}`, image: imgBase64, status: 'pending', timestamp: serverTimestamp(), userId: user.uid
          });
          setDeedDesc(''); setDeedFile(null); alert("æäº¤æˆåŠŸï¼ç­‰å¾…åº—é•·å¯©æ ¸");
        } catch(e){ alert("å¤±æ•—"); } finally { setIsUploading(false); }
      };

      const handleWaterSubmit = async () => {
        if (waterCount <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ°´é‡ ğŸ’§");
        setIsUploading(true); 
        try {
            await addDoc(getPublicRef('submissions'), {
                description: `ğŸ’§ å–æ°´æ‰“å¡ï¼š${waterCount}ml`,
                image: "https://cdn-icons-png.flaticon.com/512/3105/3105807.png", 
                status: 'pending',
                timestamp: serverTimestamp(),
                userId: user.uid
            });
            setWaterCount(250);
            alert("å–æ°´ç´€éŒ„å·²é€å‡ºï¼ç­‰å¾…åº—é•·ç™¼é»æ•¸ ğŸ’§");
        } catch(e) { alert("å¤±æ•—"); } finally { setIsUploading(false); }
      };

      const handleApprove = async (sub, customPoints) => {
        if (!customPoints || customPoints <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é»æ•¸");
        setIsProcessing(true);
        const pts = parseFloat(customPoints); // Changed to parseFloat to support decimals
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', sub.id), { status: 'approved', awardedPoints: pts });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
            totalPoints: increment(pts),
            totalIssued: increment(pts)
          });
          setApprovalPoints(prev => ({...prev, [sub.id]: ''})); // æ¸…ç©ºè¼¸å…¥æ¡†
          alert(`æ‰¹å‡†æˆåŠŸï¼å·²ç™¼æ”¾ ${pts} é»`);
        } catch(e) { alert("å¤±æ•—"); } finally { setIsProcessing(false); }
      };

      const handleDeductPoints = async () => {
        if (!penaltyDesc.trim() || !penaltyAmount) return alert("è«‹è¼¸å…¥åŸå› èˆ‡åˆ†æ•¸");
        const pts = parseFloat(penaltyAmount);
        setIsProcessing(true);
        try {
          await addDoc(getPublicRef('submissions'), {
            description: `âš ï¸ æ‰£é»ï¼š${penaltyDesc}`, status: 'deducted', awardedPoints: -pts, timestamp: serverTimestamp(), userId: user.uid
          });
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
            totalPoints: increment(-pts),
            totalRedeemed: increment(pts) 
          });
          setPenaltyDesc(''); setPenaltyAmount(''); alert(`å·²æ‰£é™¤ ${pts} é»ï¼`);
        } catch (e) { alert("å¤±æ•—"); } finally { setIsProcessing(false); }
      };

      const handleLottery = async () => {
        const cost = 5;
        if (points < cost) return alert("é»æ•¸ä¸è¶³ï¼éœ€è¦ 5 é»æ‰èƒ½æŠ½è–¯æ¢ ğŸŸ");
        if (!confirm(`ç¢ºå®šèŠ±è²» ${cost} é»æŠ½è–¯æ¢å—ï¼Ÿ`)) return;

        try {
          // 1. æ‰£é»
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
            totalPoints: increment(-cost),
            totalRedeemed: increment(cost)
          });
          
          // 2. æ©Ÿç‡åˆ¤æ–·
          const winChance = settings.lotteryProb || 0.05; // é è¨­ 10%
          const isWin = Math.random() < winChance;

          if (isWin) {
            // ä¸­ç (Status: redeemed, makes a coupon)
            await addDoc(getPublicRef('submissions'), {
              description: `ğŸŸ æŠ½çä¸­çï¼šç¾ç‚¸è–¯æ¢ä¸€ä»½`, 
              image: "https://images.unsplash.com/photo-1630384060421-a4323ceca04b?q=80&w=400&auto=format&fit=crop", 
              status: 'redeemed', 
              timestamp: serverTimestamp(), 
              userId: user.uid, 
              awardedPoints: -cost
            });
            alert("ğŸ‰ å¤ªç¥å•¦ï¼æ­å–œæŠ½ä¸­è–¯æ¢ä¸€ä»½ï¼è«‹è‡³ã€Œå…Œæ›ã€æŸ¥çœ‹åˆ¸");
          } else {
            // æ²’ä¸­ (Status: spent, only history, no coupon)
            await addDoc(getPublicRef('submissions'), {
              description: `ğŸ’¨ æŠ½çæ§“é¾œï¼šå†æ¥å†å²`, 
              status: 'spent', 
              timestamp: serverTimestamp(), 
              userId: user.uid, 
              awardedPoints: -cost
            });
            alert("ğŸ’¨ å“å‘€ï¼å·®ä¸€é»é»ï¼Œä¸‹æ¬¡ä¸€å®šä¸­ï¼");
          }
        } catch(e) {
          alert("æŠ½çå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
          console.error(e);
        }
      };

      const handleVerifyCoupon = async (couponId) => {
        if (!confirm('ç¢ºèªæ ¸éŠ·é€™å¼µåˆ¸å—ï¼Ÿ')) return;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', couponId), { status: 'verified' });
          alert("æ ¸éŠ·æˆåŠŸï¼âœ¨");
        } catch (e) { alert("å¤±æ•—"); }
      };

      const handleAddRewardByAdmin = async () => {
        if (!adminRewardName || !adminRewardCost) return alert("è³‡è¨Šä¸å…¨");
        setIsAddingReward(true);
        try {
          let img = "https://placehold.co/400x300/1e1e1e/d4af37?text=GIFT";
          if (adminRewardImage) img = await compressImage(adminRewardImage);
          await addDoc(getPublicRef('rewards'), {
            name: adminRewardName, image: img, cost: parseInt(adminRewardCost), available: true, timestamp: serverTimestamp()
          });
          setAdminRewardName(''); setAdminRewardCost(''); setAdminRewardImage(null); alert("å•†å“ä¸Šæ¶æˆåŠŸï¼ğŸ›’");
        } catch(e) { alert("å¤±æ•—"); } finally { setIsAddingReward(false); }
      };

      const handleRedeem = async (reward) => {
        if (points < Number(reward.cost)) return alert("é»æ•¸ä¸è¶³ ğŸ’");
        if (!confirm(`ç¢ºå®šå…Œæ›ã€Œ${reward.name}ã€ï¼Ÿ`)) return;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'total'), { 
            totalPoints: increment(-reward.cost),
            totalRedeemed: increment(reward.cost)
          });
          // Status: redeemed (creates a coupon)
          await addDoc(getPublicRef('submissions'), {
            description: `ğŸ å·²å…Œæ›ï¼š${reward.name}`, image: reward.image, status: 'redeemed', timestamp: serverTimestamp(), userId: user.uid, awardedPoints: -reward.cost
          });
          alert("å…Œæ›æˆåŠŸï¼ğŸ‰");
        } catch (e) { alert("å¤±æ•—"); }
      };

      const updateSettings = async (newAnnounce, newProb) => {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { 
          announce: newAnnounce || settings.announce,
          lotteryProb: newProb !== undefined ? newProb : settings.lotteryProb
        });
      };

      const unreadCountReal = user ? notifications.filter(n => !n.readBy?.includes(user.uid)).length : 0;

      if (loading) return null;

      return (
        <div className="max-w-md mx-auto shadow-2xl relative min-h-screen pb-24 sm:my-4 sm:border-2 sm:border-[#333] bg-[#121212] overflow-hidden flex flex-col no-scrollbar">
          
          {/* Header */}
          <div className="vip-gradient p-5 pb-7 text-white shadow-lg shrink-0 z-10 relative">
            <div className="flex justify-between items-center mb-5">
              <div className="flex items-center gap-2 border-l-4 border-[#d4af37] pl-3">
                <Icon name="Point" size={18} className="text-[#d4af37]" />
                <h1 className="text-xl font-bold tracking-widest uppercase italic gold-text-gradient">VIP CLUB</h1>
              </div>
              <div className="flex items-center gap-2">
                {/* éˆ´éºæ”¹ç‚ºé–‹å•Ÿå½ˆçª— */}
                <button onClick={() => setShowNotifModal(true)} className="relative p-2 bg-white/5 transition-all hover:bg-white/10 rounded-none">
                  <Icon name="Bell" size={18} className="text-[#a3a3a3]" />
                  {unreadCountReal > 0 && <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[8px] font-black w-4 h-4 flex items-center justify-center border border-[#121212] rounded-none">!</span>}
                </button>
                {/* ç®¡ç†å“¡ç™»å‡º/é–å®šæŒ‰éˆ• (å‚™ç”¨ï¼Œä½†ç¾åœ¨ä¸»è¦é åº•éƒ¨å°èˆª) */}
                <button onClick={() => isAdmin ? setIsAdmin(false) : setShowAdminLogin(true)} className="p-2 bg-white/5 hover:bg-white/10 rounded-none">
                  <Icon name={isAdmin ? "LogOut" : "Lock"} size={18} className="text-[#a3a3a3]" />
                </button>
              </div>
            </div>
            
            {/* Header é»æ•¸é¡¯ç¤º (åªåœ¨é Dashboard é é¢é¡¯ç¤ºï¼Œå› ç‚º Dashboard æœ‰å¤§å¡ç‰‡) */}
            {activeTab !== 'dashboard' && (
              <div className="flex justify-center mb-6">
                <div className="glass-card px-8 py-3 flex items-center gap-4 shadow-[0_0_20px_rgba(212,175,55,0.2)]">
                  <span className="text-4xl font-bold tracking-tight text-[#d4af37] drop-shadow-md">{parseFloat(points).toFixed(2)}</span>
                  <span className="text-[10px] font-bold text-[#888] uppercase tracking-[0.2em] border-l border-[#333] pl-4">Current<br/>Points</span>
                </div>
              </div>
            )}

            <div className="bg-[#1e1e1e] px-3 py-1.5 marquee mx-2 border border-[#333]">
              <span className="text-[11px] font-medium text-[#d4af37] tracking-wider">{announcement}</span>
            </div>
          </div>

          {/* Admin Login Modal (ç½®ä¸­é¡¯ç¤º) */}
          {showAdminLogin && !isAdmin && (
            <div className="absolute inset-0 bg-black/80 z-[60] flex items-center justify-center animate-in backdrop-blur-sm">
              <div className="bg-[#1e1e1e] p-6 shadow-2xl w-72 border border-[#333] relative">
                <button onClick={() => setShowAdminLogin(false)} className="absolute top-2 right-2 text-[#666] p-2 hover:text-white">âœ•</button>
                <p className="text-[10px] font-bold mb-6 text-[#888] uppercase tracking-widest flex items-center gap-2 justify-center">
                   <Icon name="Lock" size={14}/> Security Access
                </p>
                <input 
                  type="password" 
                  placeholder="Passcode" 
                  className="w-full bg-[#121212] border border-[#333] p-3 mb-4 text-center text-lg text-white focus:border-[#d4af37] outline-none tracking-[0.5em]" 
                  value={adminPass} 
                  onChange={(e) => setAdminPass(e.target.value)} 
                />
                <button onClick={checkAdmin} className="w-full btn-action py-3 text-xs shadow-lg">UNLOCK SYSTEM</button>
              </div>
            </div>
          )}

          {/* é€šçŸ¥å½ˆçª— */}
          {showNotifModal && (
            <div className="absolute inset-0 bg-[#121212]/95 z-50 p-6 animate-in flex flex-col">
              <div className="flex justify-between items-center mb-6 border-b border-[#333] pb-4">
                <h2 className="text-lg font-bold text-[#e5e5e5] uppercase tracking-widest flex items-center gap-2"><Icon name="Bell" className="text-[#d4af37]"/> è¨Šæ¯ä¸­å¿ƒ</h2>
                <button onClick={() => setShowNotifModal(false)} className="p-2 text-[#888]">é—œé–‰ X</button>
              </div>
              <div className="flex-1 overflow-y-auto space-y-4">
                {notifications.length === 0 && <p className="text-center text-[#444] mt-10">ç›®å‰æ²’æœ‰æ–°è¨Šæ¯</p>}
                {notifications.map(n => (
                  <div key={n.id} className={`p-5 bg-[#1e1e1e] border relative ${n.readBy?.includes(user.uid) ? 'opacity-50 border-[#333]' : 'border-[#d4af37]/50'}`}>
                    <button onClick={(e) => deleteItem(e, 'notifications', n.id, n.title)} className="absolute top-4 right-4 text-[#444] hover:text-red-500"><Icon name="Trash2" size={14} /></button>
                    <p className="font-bold text-sm text-[#e5e5e5] mb-2">{n.title}</p>
                    <p className="text-xs text-[#a3a3a3] leading-relaxed">{n.body}</p>
                  </div>
                ))}
              </div>
              <div className="mt-4 pt-4 border-t border-[#333]">
                 <button onClick={() => { if(confirm('æ¸…é™¤æ‰€æœ‰é€šçŸ¥ï¼Ÿ')) notifications.forEach(n => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', n.id))); }} className="w-full text-xs text-[#444] py-3 border border-[#333] hover:bg-[#222]">æ¸…é™¤æ‰€æœ‰è¨Šæ¯</button>
              </div>
            </div>
          )}

          <div className="p-5 flex-1 overflow-y-auto no-scrollbar">
            
            {/* 0. æ–°å¢ï¼šå„€è¡¨æ¿é¦–é  (Dashboard) */}
            {activeTab === 'dashboard' && (
              <div className="space-y-8 animate-in">
                {/* æ•¸ä½æœƒå“¡å¡ */}
                <div className="bg-gradient-to-br from-[#1e1e1e] to-[#000] p-8 border border-[#333] relative overflow-hidden shadow-2xl h-56 flex flex-col justify-between">
                  <div className="absolute top-0 right-0 w-32 h-32 bg-[#d4af37]/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                  <div className="flex justify-between items-start z-10">
                    <div>
                      <p className="text-[10px] text-[#666] tracking-[0.3em] font-bold mb-1">MEMBER CARD</p>
                      <h2 className="text-xl font-bold text-white tracking-widest italic">VIP LOUNGE</h2>
                    </div>
                    <Icon name="Point" size={32} className="text-[#d4af37]" />
                  </div>
                  <div className="z-10">
                    <p className="text-xs text-[#888] mb-1">TOTAL BALANCE</p>
                    <h1 className="text-5xl font-bold text-[#d4af37] tracking-tighter">{parseFloat(points).toFixed(2)}</h1>
                  </div>
                  <div className="flex justify-between items-end z-10 border-t border-[#333] pt-4">
                    <p className="text-[10px] text-[#444] font-mono">ID: {user?.uid?.substring(0,8).toUpperCase()}</p>
                    <p className="text-[10px] text-[#d4af37] font-bold">DIAMOND TIER</p>
                  </div>
                </div>

                {/* å¿«é€Ÿå…¥å£ */}
                <div className="grid grid-cols-2 gap-4">
                  <div onClick={() => setActiveTab('home')} className="bg-[#1e1e1e] p-6 border border-[#333] hover:border-[#d4af37] transition-all cursor-pointer group h-32 flex flex-col justify-between">
                    <Icon name="Plus" size={28} className="text-[#666] group-hover:text-[#d4af37] transition-colors" />
                    <div>
                      <h3 className="font-bold text-[#e5e5e5] text-sm">è³ºå–é»æ•¸</h3>
                      <p className="text-[10px] text-[#666] mt-1">æ‰“å¡èˆ‡ç´€éŒ„</p>
                    </div>
                  </div>
                  <div onClick={() => setActiveTab('games')} className="bg-[#1e1e1e] p-6 border border-[#333] hover:border-[#d4af37] transition-all cursor-pointer group h-32 flex flex-col justify-between">
                    <Icon name="Cards" size={28} className="text-[#666] group-hover:text-[#d4af37] transition-colors" />
                    <div>
                      <h3 className="font-bold text-[#e5e5e5] text-sm">éŠæˆ²å¤§å»³</h3>
                      <p className="text-[10px] text-[#666] mt-1">è½‰ç›¤èˆ‡21é»</p>
                    </div>
                  </div>
                </div>

                {/* ç³»çµ±ä»‹ç´¹ */}
                <div className="border-t border-[#333] pt-6">
                  <h3 className="text-xs font-bold text-[#666] mb-4 tracking-widest">SYSTEM STATUS</h3>
                  <div className="flex gap-4 overflow-x-auto no-scrollbar">
                    <div className="bg-[#111] p-4 border border-[#222] min-w-[120px] flex-shrink-0">
                      <p className="text-[10px] text-[#444]">ISSUED</p>
                      <p className="text-lg font-bold text-[#e5e5e5]">{stats.totalIssued.toFixed(2)}</p>
                    </div>
                    <div className="bg-[#111] p-4 border border-[#222] min-w-[120px] flex-shrink-0">
                      <p className="text-[10px] text-[#444]">REDEEMED</p>
                      <p className="text-lg font-bold text-[#e5e5e5]">{stats.totalRedeemed.toFixed(2)}</p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Game Tab (Replaces old Blackjack tab) */}
            {activeTab === 'games' && (
              <div className="space-y-6 animate-in flex flex-col items-center justify-start h-full pb-10">
                {activeGame === null && (
                  <div className="w-full space-y-4">
                    <h2 className="text-lg font-bold text-[#e5e5e5] px-2 mb-4">é¸æ“‡éŠæˆ²</h2>
                    
                    <div onClick={() => setActiveGame('blackjack')} className="bg-[#1e1e1e] border border-[#333] p-6 flex items-center justify-between cursor-pointer hover:border-[#d4af37] transition-all">
                      <div className="flex items-center gap-4">
                        <div className="w-12 h-12 bg-[#222] flex items-center justify-center rounded-full border border-[#333]">
                          <Icon name="Cards" size={24} className="text-[#d4af37]"/>
                        </div>
                        <div>
                          <h3 className="font-bold text-[#e5e5e5]">äºŒåä¸€é» (21)</h3>
                          <p className="text-[10px] text-[#666]">èˆ‡èŠå®¶å°æ±ºï¼Œéäº”é—œè´é›™å€</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-xs font-bold text-[#d4af37]">0.25 P</p>
                        <p className="text-[9px] text-[#444]">ENTRY</p>
                      </div>
                    </div>

                    <div onClick={() => setActiveGame('wheel')} className="bg-[#1e1e1e] border border-[#333] p-6 flex items-center justify-between cursor-pointer hover:border-[#f1c40f] transition-all">
                      <div className="flex items-center gap-4">
                        <div className="w-12 h-12 bg-[#222] flex items-center justify-center rounded-full border border-[#333]">
                          <Icon name="Wheel" size={24} className="text-[#f1c40f]"/>
                        </div>
                        <div>
                          <h3 className="font-bold text-[#e5e5e5]">å¹¸é‹è½‰ç›¤</h3>
                          <p className="text-[10px] text-[#666]">æœ€é«˜ 5 å€çå‹µï¼Œè©¦è©¦æ‰‹æ°£</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-xs font-bold text-[#f1c40f]">0.25 P</p>
                        <p className="text-[9px] text-[#444]">ENTRY</p>
                      </div>
                    </div>
                  </div>
                )}

                {activeGame === 'wheel' && (
                  <div className="w-full flex flex-col items-center gap-6 animate-in">
                    <button onClick={() => setActiveGame(null)} className="self-start text-[#666] text-xs hover:text-white mb-2">â† è¿”å›å¤§å»³</button>
                    
                    <div className="wheel-container">
                      <div className="wheel-arrow"></div>
                      <div className="wheel" style={{ transform: `rotate(${wheelRotation}deg)` }}>
                        {/* æ‰‡å½¢èˆ‡æ–‡å­—æ¨™ç±¤ - ä½¿ç”¨ç²¾æº–å®šä½å°‡æ–‡å­—æ”¾å…¥æ ¼å­ä¸­å¤® */}
                        {/* 0: 0-60 x5 (Gold) */}
                        <div className="wheel-label label-on-gold" style={{ transform: 'translate(-50%, -50%) rotate(30deg) translate(80px) rotate(90deg)' }}>x5</div>
                        {/* 1: 60-120 x2 (Black) */}
                        <div className="wheel-label label-on-dark" style={{ transform: 'translate(-50%, -50%) rotate(90deg) translate(80px) rotate(90deg)' }}>x2</div>
                        {/* 2: 120-180 x1 (White) */}
                        <div className="wheel-label label-on-light" style={{ transform: 'translate(-50%, -50%) rotate(150deg) translate(80px) rotate(90deg)' }}>x1</div>
                        {/* 3: 180-240 x0.5 (Black) */}
                        <div className="wheel-label label-on-dark" style={{ transform: 'translate(-50%, -50%) rotate(210deg) translate(80px) rotate(90deg)' }}>x0.5</div>
                        {/* 4: 240-300 x0.25 (White) */}
                        <div className="wheel-label label-on-light" style={{ transform: 'translate(-50%, -50%) rotate(270deg) translate(80px) rotate(90deg)' }}>x0.25</div>
                        {/* 5: 300-360 x0 (Black) */}
                        <div className="wheel-label label-on-dark" style={{ transform: 'translate(-50%, -50%) rotate(330deg) translate(80px) rotate(90deg)' }}>x0</div>
                      </div>
                      <div className="wheel-center">
                        <span className="text-[10px] font-bold">VIP</span>
                      </div>
                    </div>

                    <div className="text-center h-8">
                      {wheelResult && <p className="text-[#d4af37] font-bold text-lg animate-bounce">{wheelResult}</p>}
                    </div>

                    <button onClick={spinWheel} disabled={isSpinning || points < 0.25} className="btn-action w-full py-4 text-sm font-bold tracking-widest shadow-[0_0_30px_rgba(241,196,15,0.3)]">
                      {isSpinning ? 'æ—‹è½‰ä¸­...' : 'é–‹å§‹æ—‹è½‰ (-0.25 P)'}
                    </button>

                    <div className="text-[10px] text-[#666] text-center mt-4 border-t border-[#333] pt-4 w-full">
                      <p>æ©Ÿç‡èªªæ˜ï¼š</p>
                      <p>x5 (5%), x2 (10%), x1 (20%)</p>
                      <p>x0.5 (25%), x0.25 (15%), x0 (25%)</p>
                    </div>
                  </div>
                )}

                {activeGame === 'blackjack' && (
                  <div className="w-full bg-[#1e1e1e] p-6 border border-[#333] shadow-lg flex flex-col gap-4">
                    <div className="flex justify-between items-center border-b border-[#333] pb-3">
                      <div className="flex items-center gap-2">
                        <button onClick={() => setActiveGame(null)} className="text-[#666] hover:text-white mr-2">â†</button>
                        <h2 className="text-lg font-bold text-[#d4af37] flex items-center gap-2"><Icon name="Cards" size={20}/> BLACKJACK</h2>
                      </div>
                      <span className="text-xs text-[#666]">Bet: {bjBet} pts</span>
                    </div>

                    {/* Dealer Hand */}
                    <div className="flex flex-col items-center gap-2">
                      <p className="text-[10px] text-[#888] uppercase tracking-widest">Dealer</p>
                      <div className="flex gap-2">
                        {bjGameState === 'betting' ? (
                          <div className="w-12 h-16 border border-[#333] rounded bg-[#222] flex items-center justify-center text-[#444] text-xs">Empty</div>
                        ) : (
                          bjDealerHand.map((card, i) => (
                            <div key={i} className={`card ${card.color} ${i === 0 && bjGameState === 'playing' ? 'hidden' : ''}`}>
                              {i === 0 && bjGameState === 'playing' ? '' : (
                                <>
                                  <span className="val-top">{card.value}<br/>{card.suit}</span>
                                  <span className="suit">{card.suit}</span>
                                  <span className="val-bottom">{card.value}<br/>{card.suit}</span>
                                </>
                              )}
                            </div>
                          ))
                        )}
                      </div>
                      <p className="text-xs text-[#e5e5e5] font-mono h-4">
                        {bjGameState !== 'betting' && bjGameState !== 'playing' ? calculateHand(bjDealerHand) : ''}
                      </p>
                    </div>

                    {/* Message Area */}
                    <div className="h-8 flex items-center justify-center">
                      <span className="text-sm font-bold text-[#d4af37] animate-bounce">{bjMessage}</span>
                    </div>

                    {/* Player Hand */}
                    <div className="flex flex-col items-center gap-2">
                      <p className="text-xs text-[#e5e5e5] font-mono h-4">
                        {bjGameState !== 'betting' ? calculateHand(bjPlayerHand) : ''}
                      </p>
                      <div className="flex gap-2">
                        {bjGameState === 'betting' ? (
                          <div className="w-12 h-16 border border-[#333] rounded bg-[#222] flex items-center justify-center text-[#444] text-xs">Empty</div>
                        ) : (
                          bjPlayerHand.map((card, i) => (
                            <div key={i} className={`card ${card.color}`}>
                              <span className="val-top">{card.value}<br/>{card.suit}</span>
                              <span className="suit">{card.suit}</span>
                              <span className="val-bottom">{card.value}<br/>{card.suit}</span>
                            </div>
                          ))
                        )}
                      </div>
                      <p className="text-[10px] text-[#888] uppercase tracking-widest">You</p>
                    </div>

                    {/* Controls */}
                    <div className="grid grid-cols-2 gap-3 mt-2">
                      {bjGameState === 'betting' || bjGameState === 'gameOver' ? (
                        <button onClick={startBlackjack} className="col-span-2 btn-action py-3 text-xs tracking-widest">
                          ç™¼ç‰Œ (Deal) - 0.25 P
                        </button>
                      ) : (
                        <>
                          <button onClick={hitBlackjack} className="bg-[#333] text-white py-3 text-xs font-bold border border-[#444] hover:bg-[#444]">è¦ç‰Œ (Hit)</button>
                          <button onClick={standBlackjack} className="btn-action py-3 text-xs font-bold">åœç‰Œ (Stand)</button>
                          {bjPlayerHand.length === 2 && (
                            <button onClick={doubleBlackjack} className="col-span-2 bg-[#d4af37]/20 text-[#d4af37] border border-[#d4af37] py-3 text-xs font-bold hover:bg-[#d4af37]/40">
                              é›™å€ä¸‹æ³¨ (Double) - 0.25 P
                            </button>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                )}

                {/* â™ ï¸ å°ˆå±¬å°æˆ°ç´€éŒ„ (åªåœ¨éŠæˆ² Tab é¡¯ç¤º) */}
                {activeGame !== null && (
                  <div className="w-full space-y-3">
                    <h3 className="text-[10px] font-bold text-[#666] uppercase tracking-[0.2em] px-2 flex items-center gap-2"><Icon name="History" size={14} className="text-[#d4af37]"/> éŠæˆ²ç´€éŒ„</h3>
                    <div className="bg-[#1e1e1e] border border-[#333] overflow-hidden max-h-48 overflow-y-auto no-scrollbar">
                      {submissions.filter(s => s.description && (s.description.includes('21é»') || s.description.includes('è½‰ç›¤'))).length === 0 ? (
                        <p className="text-center text-[11px] text-[#444] py-6 italic">å°šç„¡å°æˆ°ç´€éŒ„</p>
                      ) : (
                        <div className="flex flex-col">
                          {submissions.filter(s => s.description && (s.description.includes('21é»') || s.description.includes('è½‰ç›¤'))).map(item => (
                            <div key={item.id} className="log-item p-3 flex justify-between items-center">
                              <div className="flex flex-col min-w-0">
                                <span className="text-[9px] text-[#666] font-bold uppercase">{item.timestamp?.toDate ? item.timestamp.toDate().toLocaleTimeString() : 'Just now'}</span>
                                <p className="text-xs font-medium text-[#ccc] truncate pr-2">{item.description}</p>
                              </div>
                              <div className={`text-sm font-bold shrink-0 ${item.awardedPoints > 0 ? 'text-[#2ed573]' : 'text-[#ff4757]'}`}>
                                {item.awardedPoints > 0 ? `+${item.awardedPoints.toFixed(2)}` : item.awardedPoints}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* 1. é›†é»åˆ†é  */}
            {activeTab === 'home' && (
              <div className="space-y-6 animate-in">
                
                {/* ğŸŒŸ æ–°å¢ï¼šå¥½äº‹æ‰“å¡å€ */}
                <div className="bg-[#1e1e1e] p-6 border border-[#333] shadow-lg relative overflow-hidden">
                  <div className="absolute top-0 right-0 w-24 h-24 bg-[#d4af37]/5 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                  <h3 className="font-bold text-[#e5e5e5] mb-5 flex gap-2 items-center tracking-wide"><Icon name="Sparkles" size={18} className="text-[#f1c40f]"/> ğŸŒŸ å¥½äº‹æ‰“å¡å€</h3>
                  <textarea className="w-full bg-[#121212] p-4 border border-[#333] text-sm min-h-[90px] outline-none focus:border-[#f1c40f] transition-all text-[#e5e5e5]" placeholder="ä»Šå¤©åšäº†ä»€éº¼å¾ˆæ£’çš„äº‹æƒ…..." value={deedDesc} onChange={(e) => setDeedDesc(e.target.value)} />
                  <div className="flex gap-3 mt-5">
                    <label className={`flex-[1.5] cursor-pointer py-3.5 flex items-center justify-center border transition-all ${deedFile ? 'border-[#f1c40f] bg-[#f1c40f]/10 text-[#f1c40f]' : 'border-[#333] bg-[#121212] text-[#666] hover:border-[#555]'}`}>
                      <Icon name="Image" size={16} className="mr-2"/> <span className="text-xs font-bold">{deedFile ? 'å·²é¸æ“‡' : 'ä¸Šå‚³ç…§ç‰‡'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={(e) => setDeedFile(e.target.files[0])} />
                    </label>
                    <button onClick={handleGoodDeedTask} disabled={isUploading} className="flex-1 btn-action py-3.5 text-xs bg-gradient-to-r from-[#f1c40f] to-[#f39c12]">æäº¤å¥½äº‹</button>
                  </div>
                </div>

                {/* è‹±æ–‡æ‰“å¡å€ */}
                <div className="bg-[#1e1e1e] p-6 border border-[#333] shadow-lg relative overflow-hidden">
                  <h3 className="font-bold text-[#e5e5e5] mb-5 flex gap-2 items-center tracking-wide"><Icon name="Book" size={18} className="text-[#d4af37]"/> è‹±æ–‡æ‰“å¡å€</h3>
                  <textarea className="w-full bg-[#121212] p-4 border border-[#333] text-sm min-h-[90px] outline-none focus:border-[#d4af37] transition-all text-[#e5e5e5]" placeholder="ä»Šå¤©è®€äº†ä»€éº¼è‹±æ–‡..." value={desc} onChange={(e) => setDesc(e.target.value)} />
                  <div className="flex gap-3 mt-5">
                    <label className={`flex-[1.5] cursor-pointer py-3.5 flex items-center justify-center border transition-all ${selectedFile ? 'border-[#d4af37] bg-[#d4af37]/10 text-[#d4af37]' : 'border-[#333] bg-[#121212] text-[#666] hover:border-[#555]'}`}>
                      <Icon name="Image" size={16} className="mr-2"/> <span className="text-xs font-bold">{selectedFile ? 'å·²é¸æ“‡' : 'ä¸Šå‚³è­‰æ˜'}</span>
                      <input type="file" accept="image/*" className="hidden" onChange={(e) => setSelectedFile(e.target.files[0])} />
                    </label>
                    <button onClick={handleUploadTask} disabled={isUploading} className="flex-1 btn-action py-3.5 text-xs">æäº¤æ‰“å¡</button>
                  </div>
                </div>

                {/* å–æ°´æ‰“å¡å€ */}
                <div className="bg-[#1e1e1e] p-6 border border-[#333] shadow-lg relative overflow-hidden group">
                  <div className="absolute -right-6 -top-6 text-[#d4af37]/10 transform rotate-12 group-hover:rotate-0 transition-all duration-700">
                    <Icon name="Droplet" size={120} />
                  </div>
                  <h3 className="font-bold text-[#e5e5e5] mb-6 flex gap-2 items-center tracking-wide relative z-10">
                    <Icon name="Droplet" size={18} className="text-[#3498db]"/> å–æ°´æ‰“å¡å€
                  </h3>
                  
                  <div className="flex flex-col items-center justify-center mb-6 relative z-10">
                    <div className="text-5xl font-bold text-[#3498db] mb-1 font-mono">{waterCount}<span className="text-lg ml-1 text-[#666]">ml</span></div>
                    <p className="text-[10px] text-[#666] tracking-widest uppercase">æœ¬æ¬¡æ”å–é‡</p>
                  </div>

                  <div className="grid grid-cols-4 gap-2 mb-6 relative z-10">
                    <button onClick={() => setWaterCount(Math.max(0, waterCount - 100))} className="p-2 border border-[#333] text-[#666] hover:text-white hover:border-[#666] flex justify-center"><Icon name="Minus" size={16}/></button>
                    <button onClick={() => setWaterCount(waterCount + 50)} className="p-2 border border-[#333] text-[#3498db] font-bold text-xs hover:bg-[#3498db]/10">+50</button>
                    <button onClick={() => setWaterCount(waterCount + 100)} className="p-2 border border-[#333] text-[#3498db] font-bold text-xs hover:bg-[#3498db]/10">+100</button>
                    <button onClick={() => setWaterCount(waterCount + 250)} className="p-2 border border-[#333] text-[#3498db] font-bold text-xs hover:bg-[#3498db]/10">+250</button>
                  </div>

                  <button onClick={handleWaterSubmit} disabled={isUploading} className="w-full py-4 bg-[#3498db] text-white font-bold text-xs tracking-widest shadow-[0_4px_20px_rgba(52,152,219,0.3)] hover:shadow-[0_4px_30px_rgba(52,152,219,0.5)] transition-all relative z-10 active:scale-95">
                    é€å‡ºå–æ°´ç´€éŒ„
                  </button>
                </div>

                <div className="space-y-4">
                    <h3 className="text-[10px] font-bold text-[#666] uppercase tracking-[0.2em] px-2 flex items-center gap-2"><Icon name="Ticket" size={14} className="text-[#d4af37]"/> æˆ‘çš„å…Œæ›åˆ¸</h3>
                    <div className="flex flex-col gap-3">
                      {/* Only show 'redeemed' or 'verified' status here. Ignore 'spent' and 'won' */}
                      {submissions.filter(s => s.status === 'redeemed' || s.status === 'verified').length === 0 && <p className="text-center text-[11px] text-[#444] py-6 border border-dashed border-[#333] italic">å°šæœªæ“æœ‰å…Œæ›åˆ¸</p>}
                      {submissions.filter(s => s.status === 'redeemed' || s.status === 'verified').map(coupon => (
                        <div key={coupon.id} className={`coupon-card p-4 flex items-center gap-4 ${coupon.status === 'verified' ? 'coupon-used' : ''}`}>
                          <div className="w-14 h-14 bg-[#121212] overflow-hidden shrink-0 border border-[#333] relative">
                            {coupon.image && <img src={coupon.image} className="w-full h-full object-cover" />}
                            {coupon.status === 'verified' && <div className="absolute inset-0 flex items-center justify-center bg-black/70 text-white font-bold text-[8px] tracking-tighter">USED</div>}
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-[#e5e5e5] truncate">{coupon.description.replace('ğŸ å·²å…Œæ›ï¼š', '').replace('ğŸŸ æŠ½çä¸­çï¼š', 'ä¸­ç: ')}</p>
                            <p className="text-[10px] text-[#d4af37] font-bold mt-1 uppercase tracking-tighter">{coupon.status === 'verified' ? 'å·²æ ¸éŠ·' : 'VIP å°ˆå±¬æ¬Šç›Š'}</p>
                          </div>
                          <button onClick={(e) => deleteItem(e, 'submissions', coupon.id, 'é€™å¼µç´€éŒ„')} className="text-[#444] hover:text-red-500 transition-colors p-2"><Icon name="Trash2" size={16}/></button>
                        </div>
                      ))}
                    </div>
                </div>

                <div className="space-y-4">
                  <h3 className="text-[10px] font-bold text-[#666] uppercase tracking-[0.2em] px-2 flex items-center gap-2"><Icon name="History" size={14} className="text-[#d4af37]"/> äº¤æ˜“ç´€éŒ„</h3>
                  <div className="bg-[#1e1e1e] border border-[#333] overflow-hidden">
                    {/* Show all completed transactions: approved, deducted, redeemed, spent, won */}
                    {submissions.filter(s => ['approved', 'deducted', 'redeemed', 'spent', 'won', 'verified'].includes(s.status)).length === 0 ? (
                      <p className="text-center text-[11px] text-[#444] py-8 italic">å°šç„¡äº¤æ˜“ç´€éŒ„</p>
                    ) : (
                      <div className="flex flex-col">
                        {submissions.filter(s => ['approved', 'deducted', 'redeemed', 'spent', 'won', 'verified'].includes(s.status)).map(item => (
                          <div key={item.id} className="log-item p-4 flex justify-between items-center">
                            <div className="flex flex-col min-w-0">
                              <span className="text-[9px] text-[#666] font-bold uppercase">{item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}</span>
                              <p className="text-xs font-medium text-[#ccc] truncate pr-2">{item.description.replace('ğŸ å·²å…Œæ›ï¼š', 'å…Œæ›: ').replace('âš ï¸ æ‰£é»ï¼š', 'æ‰£é»: ').replace('ğŸŸ æŠ½çä¸­çï¼š', 'æŠ½ç: ')}</p>
                            </div>
                            <div className={`text-sm font-bold shrink-0 ${item.awardedPoints > 0 ? 'text-[#2ed573]' : 'text-[#ff4757]'}`}>
                              {item.awardedPoints > 0 ? `+${item.awardedPoints}` : item.awardedPoints}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* 2. å…Œæ›åˆ†é  */}
            {activeTab === 'rewards' && (
              <div className="space-y-6 animate-in">
                {/* è¨±é¡˜å€å·²ç§»é™¤ */}
                
                <div className="space-y-4">
                  <h2 className="font-bold text-[#e5e5e5] text-lg flex gap-2 items-center px-1 mb-2"><Icon name="Store" className="text-[#d4af37]" size={20}/> å°Šæ¦®å…Œæ›å•†åº—</h2>
                  {rewards.length === 0 && <p className="text-center text-[#666] py-10 italic">ç›®å‰å•†åº—æ²’æœ‰å•†å“ä¸Šæ¶</p>}
                  {rewards.map(r => (
                    <div key={r.id} className="bg-[#1e1e1e] border border-[#333] shadow-lg flex h-36 group overflow-hidden relative">
                      {isAdmin && (
                        <button onClick={(e) => deleteItem(e, 'rewards', r.id, r.name)} className="absolute top-2 right-2 z-20 bg-black/50 backdrop-blur-md p-2 text-[#ccc] hover:text-red-500 transition-all">
                          <Icon name="Trash2" size={14}/>
                        </button>
                      )}
                      <div className="w-2/5 bg-[#121212] relative shrink-0 overflow-hidden m-0">
                        {r.image && <img src={r.image} className={`w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110 opacity-80`} />}
                        {!r.available && <div className="absolute inset-0 flex items-center justify-center bg-black/80 text-[#d4af37] text-[10px] font-bold tracking-widest">è£œè²¨ä¸­</div>}
                      </div>
                      <div className="flex-1 p-5 pl-4 flex flex-col justify-between min-w-0">
                        <div>
                          <h4 className="text-sm font-bold text-[#e5e5e5] truncate pr-6 leading-tight">{r.name}</h4>
                          {r.available && <p className="text-[10px] text-[#d4af37] font-bold mt-1 uppercase tracking-widest">{r.cost} P</p>}
                        </div>
                        <button onClick={() => r.available && handleRedeem(r)} disabled={!r.available || points < Number(r.cost)} className={`w-full py-2.5 text-[10px] font-bold transition-all ${r.available && points >= Number(r.cost) ? 'btn-action' : 'bg-[#333] text-[#666]'}`}>
                          {r.available ? (points >= Number(r.cost) ? 'ç«‹å³å…Œæ›' : 'é»æ•¸ä¸è¶³') : 'ç­‰å€™å®šåƒ¹'}
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* æ–°å¢ï¼šæŠ½çåˆ†é  */}
            {activeTab === 'lottery' && (
              <div className="space-y-6 animate-in flex flex-col items-center justify-center h-full pb-10">
                <div className="w-full bg-[#1e1e1e] p-8 border border-[#333] shadow-lg text-center space-y-6">
                  <div className="text-6xl animate-float">ğŸŸ</div>
                  <div>
                    <h2 className="text-2xl font-bold text-[#d4af37] uppercase tracking-widest mb-2">LUCKY DRAW</h2>
                    <p className="text-[#888] text-xs">èŠ±è²» 5 é»ï¼Œè©¦è©¦æ‰‹æ°£æŠ½è–¯æ¢</p>
                    <p className="text-[10px] text-[#444] mt-2">ç›®å‰ä¸­çæ©Ÿç‡: {Math.round((settings.lotteryProb || 0.1) * 100)}%</p>
                  </div>
                  <div className="w-full border-t border-[#333] my-4"></div>
                  <button onClick={handleLottery} className="w-full btn-action py-5 text-sm tracking-[0.2em] shadow-[0_0_30px_rgba(212,175,55,0.2)] hover:shadow-[0_0_50px_rgba(212,175,55,0.4)] transition-all">
                    ç«‹å³æŠ½ç (-5 P)
                  </button>
                </div>
                <p className="text-[10px] text-[#444] mt-4">ä¸­çå¾Œè«‹è‡³ã€Œé›†é» > å…Œæ›åˆ¸ã€æŸ¥çœ‹</p>
              </div>
            )}

            {/* 4. ç®¡ç†åˆ†é  */}
            {activeTab === 'admin' && isAdmin && (
              <div className="space-y-6 pb-10 animate-in">
                
                {/* å¾…å¯©æ ¸ä»»å‹™å€å¡Š (æ–°å¢) */}
                <div className="space-y-4">
                  <h3 className="text-[10px] font-bold text-[#666] uppercase tracking-[0.2em] px-2 flex items-center gap-2">
                    <Icon name="Check" size={14} className="text-[#d4af37]"/> å¾…å¯©æ ¸ä»»å‹™
                  </h3>
                  
                  {submissions.filter(s => s.status === 'pending').length === 0 ? (
                    <p className="text-center text-[11px] text-[#444] py-6 border border-dashed border-[#333] italic">ç›®å‰ç„¡å¾…å¯©æ ¸ä»»å‹™</p>
                  ) : (
                    <div className="space-y-4">
                      {submissions.filter(s => s.status === 'pending').map(s => (
                        <div key={s.id} className="bg-[#1e1e1e] p-4 border border-[#333] shadow-lg relative"> {/* added relative */}
                          
                          {/* åˆªé™¤æŒ‰éˆ•ç§»åˆ°å³ä¸Šè§’ï¼Œé¿å…èª¤è§¸ */}
                          <button 
                            onClick={(e) => deleteItem(e, 'submissions', s.id, 'æ­¤ç”³è«‹')} 
                            className="absolute top-2 right-2 text-[#666] hover:text-red-500 p-2 z-10 hover:bg-[#333]/50 transition-colors"
                            title="åˆªé™¤æ­¤ç”³è«‹"
                          >
                            <Icon name="Trash2" size={16} />
                          </button>

                          <div className="flex gap-4 pr-6"> {/* pr-6 é¿å…æ–‡å­—è¢«åˆªé™¤æŒ‰éˆ•è“‹ä½ */}
                            {s.image && (
                              <div className="w-16 h-16 bg-black shrink-0 border border-[#333]">
                                <img src={s.image} className="w-full h-full object-cover" />
                              </div>
                            )}
                            <div className="flex-1 min-w-0">
                               <p className="text-sm font-bold text-[#e5e5e5] break-words">{s.description}</p>
                               <p className="text-[10px] text-[#666] mt-1">{s.timestamp?.toDate ? s.timestamp.toDate().toLocaleString() : 'Just now'}</p>
                            </div>
                          </div>
                          
                          <div className="flex items-center gap-2 pt-3 mt-2 border-t border-[#333]/50">
                            <input 
                              type="number" 
                              placeholder="çµ¦äºˆé»æ•¸" 
                              className="flex-1 bg-[#121212] border border-[#333] p-2 text-sm text-white outline-none focus:border-[#d4af37]"
                              value={approvalPoints[s.id] || ''}
                              onChange={(e) => setApprovalPoints({...approvalPoints, [s.id]: e.target.value})}
                            />
                            <button 
                              onClick={() => handleApprove(s, approvalPoints[s.id])} 
                              disabled={isProcessing}
                              className="btn-action px-6 py-2 text-xs" // åŠ å¤§æŒ‰éˆ•å€åŸŸ
                            >
                              æ‰¹å‡†
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-gradient-to-r from-[#111] to-[#222] p-6 text-white shadow-lg border border-[#333] relative overflow-hidden">
                  <h2 className="text-sm font-bold flex gap-2 items-center mb-4 text-[#d4af37]"><Icon name="Chart" size={18}/> ç³»çµ±è¨­ç½®</h2>
                  
                  {/* æ©Ÿç‡æ§åˆ¶å™¨ */}
                  <div className="mb-6 p-4 border border-[#333] bg-[#000]/30">
                    <label className="text-xs text-[#888] mb-2 block font-bold uppercase">æŠ½çä¸­çæ©Ÿç‡: {Math.round((settings.lotteryProb || 0.1) * 100)}%</label>
                    <input 
                      type="range" min="0" max="1" step="0.01" 
                      className="w-full accent-[#d4af37]"
                      value={settings.lotteryProb || 0.1} 
                      onChange={(e) => setSettings({...settings, lotteryProb: parseFloat(e.target.value)})}
                      onMouseUp={() => updateSettings(null, parseFloat(settings.lotteryProb))}
                      onTouchEnd={() => updateSettings(null, parseFloat(settings.lotteryProb))}
                    />
                    <div className="flex justify-between text-[10px] text-[#444] mt-1">
                      <span>0% (å¿…è¼¸)</span><span>50%</span><span>100% (å¿…è´)</span>
                    </div>
                  </div>

                  <button onClick={() => { const t = prompt("è«‹è¼¸å…¥æ–°å…¬å‘Šï¼š", settings.announce); if(t) updateSettings(t, null); }} className="w-full bg-[#333] py-2 text-[10px] font-bold transition-all hover:bg-[#444]">ä¿®æ”¹è·‘é¦¬ç‡ˆ</button>
                </div>

                <div className="space-y-4">
                  <h3 className="text-[9px] font-bold text-[#666] px-3 uppercase tracking-[0.2em]">æ‰€æœ‰äº¤æ˜“ç´€éŒ„ (å¯åˆªé™¤)</h3>
                  <div className="bg-[#1e1e1e] border border-[#333] max-h-60 overflow-y-auto">
                    {submissions.map(s => (
                      <div key={s.id} className="flex justify-between items-center p-3 border-b border-[#333] text-xs">
                        <div className="truncate pr-2 text-[#ccc]">
                          {s.description} 
                          <span className="block text-[10px] text-[#666]">{s.timestamp?.toDate ? s.timestamp.toDate().toLocaleDateString() : 'Just now'}</span>
                        </div>
                        <button onClick={(e) => deleteItem(e, 'submissions', s.id, s.description)} className="text-[#666] hover:text-red-500 p-2"><Icon name="Trash2" size={14}/></button>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-[#1e1e1e] p-7 border border-red-900/30 shadow-xl space-y-4">
                  <h3 className="font-bold text-red-500 mb-4 flex gap-2 items-center text-sm"><Icon name="Alert" size={18}/> æ‡²ç½°æ‰£é»</h3>
                  <div className="space-y-4">
                    <input className="w-full bg-[#121212] border border-[#333] p-4 text-sm font-light outline-none focus:border-red-500 text-white" placeholder="æ‰£åˆ†åŸå› " value={penaltyDesc} onChange={(e) => setPenaltyDesc(e.target.value)} />
                    <input type="number" className="w-full bg-[#121212] border border-[#333] p-4 text-sm font-light outline-none focus:border-red-500 text-white" placeholder="é»æ•¸ (æ­£æ•¸)" value={penaltyAmount} onChange={(e) => setPenaltyAmount(e.target.value)} />
                    <button onClick={handleDeductPoints} disabled={isProcessing} className="w-full py-4 bg-red-600 text-white font-bold text-xs shadow-lg active:scale-95">åŸ·è¡Œæ‰£é»</button>
                  </div>
                </div>

                <div className="bg-[#1e1e1e] p-7 border border-[#333] space-y-4 shadow-lg">
                  <h3 className="text-sm font-bold text-[#e5e5e5] flex items-center gap-2"><Icon name="Plus" size={18} className="text-[#d4af37]"/> ä¸Šæ¶æ–°å•†å“</h3>
                  <div className="space-y-4">
                    <input className="w-full bg-[#121212] border border-[#333] p-4 text-sm font-light outline-none focus:border-[#d4af37] text-white" placeholder="å•†å“åç¨±" value={adminRewardName} onChange={(e) => setAdminRewardName(e.target.value)} />
                    <input type="number" className="w-full bg-[#121212] border border-[#333] p-4 text-sm font-light outline-none focus:border-[#d4af37] text-white" placeholder="è¨­å®šé»æ•¸" value={adminRewardCost} onChange={(e) => setAdminRewardCost(e.target.value)} />
                    <input type="file" accept="image/*" className="text-[10px] block w-full text-[#666]" onChange={(e) => setAdminRewardImage(e.target.files[0])} />
                    <button onClick={handleAddRewardByAdmin} disabled={isAddingReward} className="w-full py-3.5 btn-action font-bold text-xs">ä¸Šæ¶</button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* åº•éƒ¨å°èˆª (æ‡¸æµ®è† å›Šæ¨£å¼) */}
          <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
            <div className="bg-[#1e1e1e]/90 backdrop-blur-md border border-[#333] px-6 py-3 rounded-full flex gap-6 shadow-2xl items-center">
              <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'dashboard' ? 'text-[#d4af37] scale-110' : 'text-[#666] hover:text-[#888]'}`}>
                <Icon name="Home" size={20} className={activeTab === 'dashboard' ? 'stroke-[2px]' : ''}/>
              </button>
              <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'home' ? 'text-[#d4af37] scale-110' : 'text-[#666] hover:text-[#888]'}`}>
                <Icon name="Plus" size={20} className={activeTab === 'home' ? 'stroke-[2px]' : ''}/>
              </button>
              <button onClick={() => setActiveTab('games')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'games' ? 'text-[#d4af37] scale-110' : 'text-[#666] hover:text-[#888]'}`}>
                <Icon name="Cards" size={20} className={activeTab === 'games' ? 'stroke-[2px]' : ''}/>
              </button>
              <button onClick={() => setActiveTab('rewards')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'rewards' ? 'text-[#d4af37] scale-110' : 'text-[#666] hover:text-[#888]'}`}>
                <Icon name="Gift" size={20} className={activeTab === 'rewards' ? 'stroke-[2px]' : ''}/>
              </button>
              <button onClick={() => setActiveTab('lottery')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'lottery' ? 'text-[#d4af37] scale-110' : 'text-[#666] hover:text-[#888]'}`}>
                <Icon name="Dice" size={20} className={activeTab === 'lottery' ? 'stroke-[2px]' : ''}/>
              </button>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
